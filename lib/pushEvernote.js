// Generated by CoffeeScript 1.10.0
(function() {
  var Evernote, PushEvernote, ZhihuDaily, async, cheerio, crypto, inlineCss, makeNote, noteStore, request, txErr;

  noteStore = require('./noteStore');

  async = require('async');

  request = require('request');

  cheerio = require('cheerio');

  ZhihuDaily = require('../models/zhihu_daily');

  inlineCss = require('inline-css');

  crypto = require('crypto');

  makeNote = require('./makeNote');

  txErr = require('./txErr');

  Evernote = require('evernote').Evernote;

  PushEvernote = (function() {
    function PushEvernote(noteStore1, noteBook, url, id, title) {
      this.noteStore = noteStore1;
      this.noteBook = noteBook;
      this.url = url;
      this.id = id;
      this.title = title;
      this.resourceArr = [];
    }

    PushEvernote.prototype.pushNote = function(cb) {
      var self;
      self = this;
      return async.series([
        function(callback) {
          return self.changeContent(function(err) {
            if (err) {
              return cb();
            }
            return callback();
          });
        }, function(callback) {
          return self.createNote(function(err) {
            if (err) {
              return cb();
            }
            return callback();
          });
        }, function(callback) {
          return self.changeStatus(function(err) {
            if (err) {
              return cb();
            }
            return cb();
          });
        }
      ]);
    };

    PushEvernote.prototype.createNote = function(cb) {
      var self;
      self = this;
      return makeNote(self.noteStore, self.title.trim(), self.enContent, {
        sourceURL: self.url,
        resources: self.resourceArr,
        notebookGuid: self.noteBook
      }, function(err, note) {
        if (err) {
          return txErr({
            err: err,
            fun: 'createNote',
            id: self.id
          }, cb(err));
        }
        console.log("##############");
        console.log(note.title + " create ok");
        console.log("##############");
        self.guid = note.guid;
        return cb();
      });
    };

    PushEvernote.prototype.changeStatus = function(cb) {
      var self;
      self = this;
      return async.waterfall([
        function(callback) {
          return ZhihuDaily.findOne({
            id: self.id
          }, function(err, row) {
            if (err) {
              return txErr({
                err: err,
                fun: 'changeStatus',
                id: self.id
              }, cb(err));
            }
            if (!row) {
              return txErr({
                err: 'data not find',
                id: self.id
              }, cb("not find db"));
            }
            return callback(null, row);
          });
        }, function(row, callback) {
          row.status = 2;
          return row.save(function(err, res) {
            if (err) {
              return txErr({
                err: err,
                id: self.id
              }, cb(err));
            }
            return cb();
          });
        }
      ]);
    };

    PushEvernote.prototype.changeContent = function(cb) {
      var self;
      self = this;
      return async.waterfall([
        function(callback) {
          return request.get(self.url, function(err, res, body) {
            if (err) {
              return txErr({
                err: err,
                fun: 'getContent',
                url: self.url
              }, cb(err));
            }
            return callback(null, body);
          });
        }, function(body, callback) {
          return inlineCss(body, {
            url: 'http://daily.zhihu.com'
          }, function(err, html) {
            if (err) {
              return txErr({
                body: body,
                err: err,
                fun: 'changeContent-inlineCss'
              }, cb(err));
            }
            return callback(null, html);
          });
        }, function(html, callback) {
          var $, $cHtml, $contentDiv;
          $ = cheerio.load(html);
          $contentDiv = $("body");
          if ($contentDiv.length === 0) {
            return txErr({
              err: 'not content',
              fun: 'changeContent-cherrio',
              html: html
            }, cb('not content'));
          }
          self.filterZhihu($);
          $cHtml = cheerio.load($contentDiv.html());
          self.filterHtml($cHtml);
          return callback(null, $cHtml);
        }, function($cHtml, callback) {
          return self.changeImgHtml($cHtml, cb);
        }
      ]);
    };

    PushEvernote.prototype.changeImgHtml = function($, cb) {
      var imgs, imgsIndex, self;
      self = this;
      imgs = $("img");
      console.log(self.title + " find img length => " + imgs.length);
      imgsIndex = 0;
      return async.eachLimit(imgs, 5, function(item, callback) {
        var src, styleAttr;
        src = $(item).attr('src');
        styleAttr = $(item).attr("style");
        styleAttr = "style=" + "'" + styleAttr + "'";
        imgsIndex += 1;
        console.log("开始获取[" + imgsIndex + ", " + self.title + ", " + src + "]");
        return self.readImgRes(src, function(err, resource) {
          var hexHash, md5, newTag;
          if (err) {
            return txErr({
              err: err,
              title: self.title,
              url: src,
              fun: 'changeContent-changeImgHtml'
            }, cb(err));
          }
          self.resourceArr.push(resource);
          md5 = crypto.createHash('md5');
          md5.update(resource.image);
          hexHash = md5.digest('hex');
          newTag = ("<en-media type=" + resource.mime + " hash=" + hexHash + " ") + styleAttr + " />";
          $(item).replaceWith(newTag);
          return callback();
        });
      }, function() {
        console.log(self.title + " " + imgs.length + " imgs down ok");
        self.enContent = $.html({
          xmlMode: true,
          decodeEntities: true
        });
        return cb();
      });
    };

    PushEvernote.prototype.filterZhihu = function($) {
      var bottom_wrap, global_header, header_for_mobile, qr;
      global_header = $("body > div.global-header")[0];
      qr = $("div.main-wrap.content-wrap > div.qr")[0];
      header_for_mobile = $("body > .header-for-mobile")[0];
      bottom_wrap = $("body > div.bottom-wrap")[0];
      $(global_header).remove();
      $(qr).remove();
      $(header_for_mobile).remove();
      $(bottom_wrap).remove();
      if ($(".content-inner").find(".question").length >= 2) {
        return $(".content-inner").find(".question").last().remove();
      }
    };

    PushEvernote.prototype.filterHtml = function($) {
      var self;
      self = this;
      $("script").remove();
      $("*").map(function(i, elem) {
        var k, ref, results, v;
        ref = elem.attribs;
        results = [];
        for (k in ref) {
          v = ref[k];
          if (k !== 'style' && k !== "src" && k !== "href") {
            $(this).removeAttr(k);
          }
          if (k === 'href') {
            if (!self.checkUrl(v)) {
              results.push($(this).removeAttr(k));
            } else {
              results.push(void 0);
            }
          } else {
            results.push(void 0);
          }
        }
        return results;
      });
      $("iframe").remove();
      $("article").each(function() {
        return $(this).replaceWith('<div>' + $(this).html() + '</div>');
      });
      $("section").each(function() {
        return $(this).replaceWith('<div>' + $(this).html() + '</div>');
      });
      $("header").each(function() {
        return $(this).replaceWith('<div>' + $(this).html() + '</div>');
      });
      $("noscript").each(function() {
        return $(this).replaceWith('<div>' + $(this).html() + '</div>');
      });
      $("figure").each(function() {
        return $(this).replaceWith('<div>' + $(this).html() + '</div>');
      });
      return $("figcaption").each(function() {
        return $(this).replaceWith('<div>' + $(this).html() + '</div>');
      });
    };

    PushEvernote.prototype.checkUrl = function(href) {
      var re, strRegex;
      strRegex = "^((https|http|ftp|rtsp|mms)?://)";
      +"?(([0-9a-z_!~*'().&=+$%-]+: )?[0-9a-z_!~*'().&=+$%-]+@)?";
      +"(([0-9]{1,3}/.){3}[0-9]{1,3}" + "|";
      +"([0-9a-z_!~*'()-]+/.)*";
      +"([0-9a-z][0-9a-z-]{0,61})?[0-9a-z]/.";
      +"[a-z]{2,6})";
      +"(:[0-9]{1,4})?";
      +"((/?)|";
      +"(/[0-9a-z_!~*'().;?:@&=+$,%#-]+)+/?)$";
      re = new RegExp(strRegex);
      if (re.test(href)) {
        return true;
      } else {
        return false;
      }
    };

    PushEvernote.prototype.readImgRes = function(imgUrl, cb) {
      var op, self;
      self = this;
      op = self.reqOp(imgUrl);
      op.encoding = 'binary';
      return async.auto({
        readImg: function(callback) {
          return request.get(op, function(err, res, body) {
            var mimeType;
            if (err) {
              return cb(err);
            }
            mimeType = res.headers['content-type'];
            mimeType = mimeType.split(';')[0];
            return callback(null, body, mimeType);
          });
        },
        enImg: [
          'readImg', function(callback, result) {
            var data, hash, image, mimeType, resource;
            mimeType = result.readImg[1];
            image = new Buffer(result.readImg[0], 'binary');
            hash = image.toString('base64');
            data = new Evernote.Data();
            data.size = image.length;
            data.bodyHash = hash;
            data.body = image;
            resource = new Evernote.Resource();
            resource.mime = mimeType;
            resource.data = data;
            resource.image = image;
            return cb(null, resource);
          }
        ]
      });
    };

    PushEvernote.prototype.reqOp = function(getUrl) {
      var options;
      options = {
        timeout: 50000,
        url: getUrl,
        headers: {
          'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_3) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/42.0.2311.90 Safari/537.36'
        }
      };
      return options;
    };

    return PushEvernote;

  })();

  module.exports = PushEvernote;

}).call(this);

//# sourceMappingURL=pushEvernote.js.map
